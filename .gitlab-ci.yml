# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-desktop
#
# Tauri desktop application with SolidJS frontend
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Upstream trigger: Verify compatibility when core merges to main
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'
      - '/ci-templates/downstream.yml'
      - '/ci-templates/reuse.yml'

stages:
  - lint
  - test
  - security
  - verify

variables:
  # Additional paths to exclude for desktop app
  SAST_EXCLUDED_PATHS: "target/, node_modules/, dist/"
  DS_EXCLUDED_PATHS: "target/, node_modules/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/, node_modules/"

# Node.js cache
.node-cache:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-node
    paths:
      - ui/node_modules/

.node-job:
  image: node:20
  extends: .node-cache

# ============================================================
# Lint Stage — Preflight Gate (change-based)
# ============================================================
# Cheapest checks run first. Test + security jobs wait for these
# to pass before starting (PI-13 fail-fast DAG).

# Tauri requires GTK3 and WebKit2GTK for Linux builds
.tauri-deps:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

# Build frontend first (needed for Tauri's generate_context!)
build:frontend-dist:
  extends: [.node-job, .timeout-quick]
  stage: lint
  needs: []
  script:
    - cd ui && npm ci && npm run build
  artifacts:
    paths:
      - ui/dist/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - "src-tauri/**/*"
          - ".gitlab-ci.yml"
    # Also run on upstream triggers (needed by verify:upstream-compat)
    - if: $CI_PIPELINE_SOURCE == "pipeline" || $CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "api"

# Rust linting (runs on Rust code changes)
lint:rust-format:
  extends: [.rust-job, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add rustfmt
    - cd src-tauri && cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/**/*.rs"
          - "src-tauri/Cargo.toml"
          - ".gitlab-ci.yml"

lint:rust-clippy:
  extends: [.rust-job, .tauri-deps, .timeout-standard]
  stage: lint
  needs: [build:frontend-dist]
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add clippy
    - cd src-tauri && cargo clippy --all-targets --no-default-features --features custom-protocol -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/**/*.rs"
          - "src-tauri/Cargo.toml"
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Frontend linting (runs on frontend code changes)
lint:frontend:
  extends: [.node-job, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - cd ui && npm ci && npm run lint || echo "No lint script configured"
    - npm run typecheck || echo "No typecheck script configured"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# ============================================================
# Test Stage (change-based, gated by lint)
# ============================================================

# Rust tests
test:rust:
  extends: [.rust-job, .tauri-deps, .timeout-standard]
  stage: test
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: lint:rust-format
      optional: true
    - job: lint:rust-clippy
      optional: true
  script:
    - cd src-tauri && cargo test --all-targets --no-default-features --features custom-protocol
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/**/*"
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Frontend tests (unit tests only — E2E requires Tauri runtime)
test:frontend:
  extends: [.node-job, .timeout-standard]
  stage: test
  needs:
    - job: lint:frontend
      optional: true
  script:
    - cd ui && npm ci && npm test || echo "No test script configured"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Visual regression tests (Playwright screenshot comparison)
# NOTE: Requires Tauri runtime (Rust + GTK + WebKit). Cannot run in a
# plain Node.js container. Allowed to fail until full Tauri CI image is
# available. Run locally with: cd ui && npm run test:visual
test:visual-regression:
  extends: [.node-job, .timeout-standard]
  stage: test
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: lint:frontend
      optional: true
  allow_failure: true
  script:
    - cd ui && npm ci
    - npx playwright install --with-deps chromium
    - npx playwright test --grep @visual --project visual-chromium --reporter=html
  artifacts:
    when: always
    paths:
      - ui/playwright-report/
      - ui/e2e/test-results/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# ============================================================
# Security Stage (change-based, gated by lint, parallel with test)
# ============================================================

# Rust security audit (runs on dependency changes)
security:audit:
  extends: [.rust-job, .timeout-quick]
  stage: security
  needs:
    - job: lint:rust-format
      optional: true
  cache:
    policy: pull  # Read-only cache
  script:
    - cargo install cargo-audit || true
    - cd src-tauri && cargo audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/Cargo.toml"
          - "src-tauri/Cargo.lock"
          - ".gitlab-ci.yml"

# Full cargo-deny check: advisories, licenses, bans, sources
security:deny:
  extends: [.rust-job, .timeout-quick]
  stage: security
  needs:
    - job: lint:rust-format
      optional: true
  cache:
    policy: pull
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - cargo binstall cargo-deny --no-confirm 2>/dev/null || cargo install cargo-deny || true
    - cd src-tauri && cargo deny check

# npm audit for frontend (runs on package changes)
security:npm-audit:
  extends: [.node-job, .timeout-quick]
  stage: security
  needs:
    - job: lint:frontend
      optional: true
  cache:
    policy: pull
  script:
    - cd ui && npm ci && npm audit --audit-level=moderate || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/package.json"
          - "ui/package-lock.json"
          - ".gitlab-ci.yml"

# ============================================================
# Verify Stage (upstream trigger only)
# ============================================================
# Runs when core merges to main and triggers this repo via
# verify:downstream-rust. Verifies the Tauri backend builds and
# tests pass against the updated vauchi-core.
# Requires build:frontend-dist (Tauri's generate_context! needs ui/dist/).

verify:upstream-compat:
  extends: [.rust-job, .tauri-deps, .verify-on-upstream, .timeout-standard]
  stage: verify
  needs: [build:frontend-dist]
  script:
    - cd src-tauri && cargo test --all-targets --no-default-features --features custom-protocol
