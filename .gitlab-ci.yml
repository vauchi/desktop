# GitLab CI for vauchi-desktop
#
# Tauri desktop application with SolidJS frontend
#
# Pipeline strategy:
#   - MR: Full validation (Rust + JS lint, test, security)
#   - Main: No pipeline (validated via MR)
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'

stages:
  - lint
  - test
  - security

variables:
  # Additional paths to exclude for desktop app
  SAST_EXCLUDED_PATHS: "target/, node_modules/, dist/"
  DS_EXCLUDED_PATHS: "target/, node_modules/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/, node_modules/"

# Node.js cache
.node-cache:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-node
    paths:
      - ui/node_modules/

.node-job:
  image: node:20
  extends: .node-cache

# ============================================================
# Lint Stage (MR only)
# ============================================================

# Tauri requires GTK3 and WebKit2GTK for Linux builds
.tauri-deps:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

# Build frontend first (needed for Tauri's generate_context!)
build:frontend-dist:
  extends: [.node-job, .validation-only]
  stage: lint
  script:
    - cd ui && npm ci && npm run build
  artifacts:
    paths:
      - ui/dist/
    expire_in: 1 hour

# Rust linting
lint:rust-format:
  extends: [.rust-job, .validation-only]
  stage: lint
  script:
    - rustup component add rustfmt
    - cd src-tauri && cargo fmt --all -- --check

lint:rust-clippy:
  extends: [.rust-job, .validation-only, .tauri-deps]
  stage: lint
  needs: [build:frontend-dist]
  script:
    - rustup component add clippy
    - cd src-tauri && cargo clippy --all-targets -- -D warnings

# Frontend linting
lint:frontend:
  extends: [.node-job, .validation-only]
  stage: lint
  script:
    - cd ui && npm ci && npm run lint || echo "No lint script configured"
    - npm run typecheck || echo "No typecheck script configured"

# ============================================================
# Test Stage (MR only)
# ============================================================

# Rust tests
test:rust:
  extends: [.rust-job, .validation-only, .tauri-deps]
  stage: test
  needs: [build:frontend-dist]
  script:
    - cd src-tauri && cargo test --all-targets

# Frontend tests
test:frontend:
  extends: [.node-job, .validation-only]
  stage: test
  script:
    - cd ui && npm ci && npm test || echo "No test script configured"

# ============================================================
# Security Stage (MR only)
# ============================================================

# Rust security audit
security:audit:
  extends: [.rust-job, .validation-cargo]
  stage: security
  script:
    - cargo install cargo-audit || true
    - cd src-tauri && cargo audit

# npm audit for frontend
security:npm-audit:
  extends: [.node-job, .validation-only]
  stage: security
  script:
    - cd ui && npm ci && npm audit --audit-level=moderate || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "ui/package.json"
        - "ui/package-lock.json"
