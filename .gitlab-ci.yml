# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-desktop
#
# Tauri desktop application with SolidJS frontend
#
# Performance optimizations:
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Main: No pipeline (validated via MR)
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'

stages:
  - lint
  - test
  - security

variables:
  # Additional paths to exclude for desktop app
  SAST_EXCLUDED_PATHS: "target/, node_modules/, dist/"
  DS_EXCLUDED_PATHS: "target/, node_modules/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/, node_modules/"

# Node.js cache
.node-cache:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-node
    paths:
      - ui/node_modules/

.node-job:
  image: node:20
  extends: .node-cache

# ============================================================
# Local Template Definitions (until scripts MR is merged)
# ============================================================

.timeout-quick:
  timeout: 10 minutes

.timeout-standard:
  timeout: 30 minutes

# ============================================================
# Lint Stage (change-based)
# ============================================================

# Tauri requires GTK3 and WebKit2GTK for Linux builds
.tauri-deps:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

# Build frontend first (needed for Tauri's generate_context!)
build:frontend-dist:
  extends: [.node-job, .timeout-quick]
  stage: lint
  script:
    - cd ui && npm ci && npm run build
  artifacts:
    paths:
      - ui/dist/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "ui/**/*"
        - "src-tauri/**/*"
        - ".gitlab-ci.yml"

# Rust linting (runs on Rust code changes)
lint:rust-format:
  extends: [.rust-job, .timeout-quick]
  stage: lint
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add rustfmt
    - cd src-tauri && cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "src-tauri/**/*.rs"
        - "src-tauri/Cargo.toml"
        - ".gitlab-ci.yml"

lint:rust-clippy:
  extends: [.rust-job, .tauri-deps, .timeout-standard]
  stage: lint
  needs: [build:frontend-dist]
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - rustup component add clippy
    - cd src-tauri && cargo clippy --all-targets -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "src-tauri/**/*.rs"
        - "src-tauri/Cargo.toml"
        - "ui/**/*"
        - ".gitlab-ci.yml"

# Frontend linting (runs on frontend code changes)
lint:frontend:
  extends: [.node-job, .timeout-quick]
  stage: lint
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - cd ui && npm ci && npm run lint || echo "No lint script configured"
    - npm run typecheck || echo "No typecheck script configured"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "ui/**/*"
        - ".gitlab-ci.yml"

# ============================================================
# Test Stage (change-based)
# ============================================================

# Rust tests
test:rust:
  extends: [.rust-job, .tauri-deps, .timeout-standard]
  stage: test
  needs: [build:frontend-dist]
  script:
    - cd src-tauri && cargo test --all-targets
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "src-tauri/**/*"
        - "ui/**/*"
        - ".gitlab-ci.yml"

# Frontend tests
test:frontend:
  extends: [.node-job, .timeout-standard]
  stage: test
  script:
    - cd ui && npm ci && npm test || echo "No test script configured"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "ui/**/*"
        - ".gitlab-ci.yml"

# ============================================================
# Security Stage (change-based)
# ============================================================

# Rust security audit (runs on dependency changes)
security:audit:
  extends: [.rust-job, .timeout-quick]
  stage: security
  cache:
    policy: pull  # Read-only cache
  script:
    - cargo install cargo-audit || true
    - cd src-tauri && cargo audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "src-tauri/Cargo.toml"
        - "src-tauri/Cargo.lock"
        - ".gitlab-ci.yml"

# npm audit for frontend (runs on package changes)
security:npm-audit:
  extends: [.node-job, .timeout-quick]
  stage: security
  script:
    - cd ui && npm ci && npm audit --audit-level=moderate || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "ui/package.json"
        - "ui/package-lock.json"
        - ".gitlab-ci.yml"
