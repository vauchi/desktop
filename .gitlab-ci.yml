# SPDX-FileCopyrightText: 2026 Mattia Egloff <mattia.egloff@pm.me>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# GitLab CI for vauchi-desktop
#
# Tauri desktop application with SolidJS frontend
#
# Performance optimizations:
#   - Self-hosted runners: sccache, persistent caches, load-balanced
#   - Docker executor for Node.js jobs (allyson-docker)
#   - Change-based rules: Jobs run only when relevant files change
#   - Timeouts: Prevent runaway jobs from blocking runners
#   - Read-only cache for lint jobs
#
# Pipeline strategy:
#   - MR: Validation on relevant file changes
#   - Upstream trigger: Verify compatibility when core merges to main
#
# Uses shared templates from vauchi/scripts for consistency.

# Include shared templates
include:
  - project: 'vauchi/scripts'
    ref: main
    file:
      - '/ci-templates/rust-base.yml'
      - '/ci-templates/security.yml'
      - '/ci-templates/mr-rules.yml'
      - '/ci-templates/downstream.yml'
      - '/ci-templates/reuse.yml'
      - '/ci-templates/test-quality.yml'

stages:
  - lint
  - test
  - security
  - mutation
  - verify

variables:
  # Additional paths to exclude for desktop app
  SAST_EXCLUDED_PATHS: "target/, node_modules/, dist/"
  DS_EXCLUDED_PATHS: "target/, node_modules/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/, node_modules/"

# Clone sibling locales repo (needed by vauchi-core build.rs)
.clone-locales:
  before_script:
    - if [ ! -d ../locales ]; then git clone --depth=1 https://gitlab.com/vauchi/locales.git ../locales; else git -C ../locales pull --ff-only 2>/dev/null || true; fi

# Node.js jobs run on allyson-docker (Docker executor)
.node-job:
  image: node:20
  tags: [docker]
  variables:
    npm_config_cache: ${CI_PROJECT_DIR}/.npm
    PLAYWRIGHT_BROWSERS_PATH: ${CI_PROJECT_DIR}/.playwright
  cache:
    key: ${CI_COMMIT_REF_SLUG}-node
    fallback_keys:
      - ${CI_DEFAULT_BRANCH}-node
      - node
    paths:
      - .npm/
      - .playwright/

# Desktop Rust cache — Cargo.lock and target/ are in src-tauri/
.desktop-cache:
  cache:
    key:
      files:
        - src-tauri/Cargo.lock
      prefix: rust-${CI_JOB_NAME}
    fallback_keys:
      - rust-${CI_JOB_NAME}-${CI_DEFAULT_BRANCH}
      - rust-${CI_JOB_NAME}
    paths:
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - src-tauri/target/
    policy: pull-push

# ============================================================
# Lint Stage — Preflight Gate (change-based)
# ============================================================
# Cheapest checks run first. Test + security jobs wait for these
# to pass before starting (PI-13 fail-fast DAG).

# Build frontend first (needed for Tauri's generate_context!)
build:frontend-dist:
  extends: [.node-job, .timeout-quick]
  stage: lint
  needs: []
  script:
    - cd ui && npm ci --prefer-offline && npm run build
  artifacts:
    paths:
      - ui/dist/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - "src-tauri/**/*"
          - ".gitlab-ci.yml"
    # Also run on upstream triggers (needed by verify:upstream-compat)
    - if: $CI_PIPELINE_SOURCE == "pipeline" || $CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "api"

# HTML linting (runs on frontend HTML changes)
lint:html:
  stage: lint
  tags:
    - self-hosted
    - node
  needs: []
  script:
    - htmlhint ui/index.html
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/index.html"
          - ".gitlab-ci.yml"

# CSS linting (runs on stylesheet changes)
lint:css:
  stage: lint
  tags:
    - self-hosted
    - node
  needs: []
  script:
    - cd ui && npm ci --prefer-offline && npm run lint:css
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/src/**/*.css"
          - ".gitlab-ci.yml"

# Rust linting (runs on Rust code changes)
lint:rust-format:
  extends: [.rust-runner-nocache, .timeout-quick]
  stage: lint
  needs: []
  script:
    - cd src-tauri && cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/**/*.rs"
          - "src-tauri/Cargo.toml"
          - ".gitlab-ci.yml"

lint:rust-clippy:
  extends: [.rust-runner, .desktop-cache, .timeout-standard]
  stage: lint
  needs: [build:frontend-dist]
  cache:
    policy: pull  # Read-only cache for lint
  before_script:
    - !reference [.self-hosted, before_script]
    - !reference [.clone-locales, before_script]
  script:
    - cd src-tauri && cargo clippy --all-targets --no-default-features --features custom-protocol -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/**/*.rs"
          - "src-tauri/Cargo.toml"
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Frontend linting (runs on frontend code changes)
lint:frontend:
  extends: [.node-job, .timeout-quick]
  stage: lint
  needs: []
  cache:
    policy: pull  # Read-only cache for lint
  script:
    - cd ui && npm ci --prefer-offline && npm run lint --if-present
    - npm run typecheck --if-present
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# ============================================================
# Test Stage (change-based, gated by lint)
# ============================================================

# Rust tests
test:rust:
  extends: [.rust-runner, .desktop-cache, .timeout-standard]
  stage: test
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: lint:rust-format
      optional: true
    - job: lint:rust-clippy
      optional: true
  before_script:
    - !reference [.self-hosted, before_script]
    - !reference [.clone-locales, before_script]
  script:
    - cd src-tauri && cargo nextest run --all-targets --no-default-features --features custom-protocol
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/**/*"
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Frontend functional tests — excludes @visual and @a11y (they have
# dedicated jobs). Runs only chromium (other browsers not installed).
test:frontend:
  extends: [.node-job, .timeout-quick]
  stage: test
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: lint:frontend
      optional: true
  script:
    - cd ui && npm ci --prefer-offline
    - npx playwright install --with-deps chromium
    - npx playwright test --project=chromium --grep-invert "@visual|@a11y"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Visual regression tests (Playwright screenshot comparison)
# NOTE: Requires Tauri runtime (Rust + GTK + WebKit). Cannot run in a
# plain Node.js container. Allowed to fail until full Tauri CI image is
# available. Run locally with: cd ui && npm run test:visual
test:visual-regression:
  extends: [.node-job, .timeout-standard]
  stage: test
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: lint:frontend
      optional: true
  allow_failure: true
  script:
    - cd ui && npm ci --prefer-offline
    - npx playwright install --with-deps chromium
    - npx playwright test --grep @visual --project visual-chromium --reporter=html
  artifacts:
    when: always
    paths:
      - ui/playwright-report/
      - ui/e2e/test-results/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# Accessibility tests — axe-core critical violations fail the build (PI-12)
# Runs the @a11y Playwright tests which use @axe-core/playwright to check
# WCAG 2.0 AA compliance on all pages. Critical violations are blocking.
test:accessibility:
  extends: [.node-job, .timeout-standard]
  stage: test
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: lint:frontend
      optional: true
  script:
    - cd ui && npm ci --prefer-offline
    - npx playwright install --with-deps chromium
    - npx playwright test --grep @a11y --project chromium --reporter=html
  artifacts:
    when: always
    paths:
      - ui/playwright-report/
      - ui/e2e/test-results/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/**/*"
          - ".gitlab-ci.yml"

# ============================================================
# Mutation Stage (PI-02)
# ============================================================

# Nightly full mutation testing on Rust backend (scheduled pipeline)
mutation:nightly:
  extends: [.rust-runner, .desktop-cache, .timeout-extended]
  stage: mutation
  needs: [build:frontend-dist]
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - !reference [.self-hosted, before_script]
    - !reference [.clone-locales, before_script]
  script:
    - cd src-tauri && cargo mutants --no-default-features --features custom-protocol --timeout 60 --output target/mutants
  artifacts:
    paths:
      - src-tauri/target/mutants/
    expire_in: 1 week

# Per-MR incremental mutation testing (advisory, runs after Rust tests pass)
mutation:incremental:
  extends: [.rust-runner, .desktop-cache, .timeout-extended]
  stage: mutation
  needs:
    - job: build:frontend-dist
      artifacts: true
    - job: test:rust
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true
  variables:
    GIT_DEPTH: "100"
  before_script:
    - !reference [.self-hosted, before_script]
    - !reference [.clone-locales, before_script]
  script:
    - git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" --depth=100
    - git diff "origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"...HEAD > mr.diff
    - cd src-tauri && cargo mutants --no-default-features --features custom-protocol --in-diff ../mr.diff --timeout 120 --mutant-limit 50 --baseline skip
  artifacts:
    paths:
      - src-tauri/mutants.out/
    expire_in: 1 week
    when: always

# ============================================================
# Security Stage (change-based, gated by lint, parallel with test)
# ============================================================

# Rust security audit (runs on dependency changes)
security:audit:
  extends: [.rust-runner-readonly, .timeout-quick]
  stage: security
  needs:
    - job: lint:rust-format
      optional: true
  cache:
    key:
      files:
        - src-tauri/Cargo.lock
      prefix: rust-${CI_JOB_NAME}
    fallback_keys:
      - rust-${CI_JOB_NAME}-${CI_DEFAULT_BRANCH}
      - rust-${CI_JOB_NAME}
    paths:
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - src-tauri/target/
    policy: pull
  script:
    - cd src-tauri && cargo audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "src-tauri/Cargo.toml"
          - "src-tauri/Cargo.lock"
          - ".gitlab-ci.yml"

# Full cargo-deny check: advisories, licenses, bans, sources
security:deny:
  extends: [.rust-runner-readonly, .timeout-quick]
  stage: security
  needs:
    - job: lint:rust-format
      optional: true
  cache:
    key:
      files:
        - src-tauri/Cargo.lock
      prefix: rust-${CI_JOB_NAME}
    fallback_keys:
      - rust-${CI_JOB_NAME}-${CI_DEFAULT_BRANCH}
      - rust-${CI_JOB_NAME}
    paths:
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - src-tauri/target/
    policy: pull
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - cd src-tauri && cargo deny check

# npm audit for frontend (runs on package changes)
security:npm-audit:
  extends: [.node-job, .timeout-quick]
  stage: security
  needs:
    - job: lint:frontend
      optional: true
  cache:
    policy: pull
  script:
    - cd ui && npm ci --prefer-offline && npm audit --audit-level=moderate || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "ui/package.json"
          - "ui/package-lock.json"
          - ".gitlab-ci.yml"

# ============================================================
# Verify Stage (upstream trigger only)
# ============================================================
# Runs when core merges to main and triggers this repo via
# verify:downstream-rust. Verifies the Tauri backend builds and
# tests pass against the updated vauchi-core.
# Requires build:frontend-dist (Tauri's generate_context! needs ui/dist/).

verify:upstream-compat:
  extends: [.rust-runner, .desktop-cache, .verify-on-upstream, .timeout-standard]
  stage: verify
  needs: [build:frontend-dist]
  before_script:
    - !reference [.self-hosted, before_script]
    - !reference [.clone-locales, before_script]
  script:
    - cd src-tauri && cargo nextest run --all-targets --no-default-features --features custom-protocol
